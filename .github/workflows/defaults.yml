name: Setup Workflow Defaults

on:
  workflow_call:
    inputs:
      github_tag:
        description: 'Version Tag to build'
        required: false
        default: "n8.0.1"
        type: string
      build_type:
        description: 'Build type of included libraries'
        required: false
        default: 'essentials'
        type: string
      link_type:
        description: 'Link type of libraries'
        required: false
        default: 'shared'
        type: string
      msystem:
        description: 'MSYS2 System Environment'
        required: true
        default: 'CLANGARM64'
        type: string
      environment:
        description: 'Deploy Environment'
        required: false
        default: 'base'
        type: string
    outputs:
      github_tag:
        value: ${{ jobs.defaults.outputs.github_tag }}
      build_type:
        value: ${{ jobs.defaults.outputs.build_type }}
      link_type:
        value: ${{ jobs.defaults.outputs.link_type }}
      msystem:
        value: ${{ jobs.defaults.outputs.msystem }}
      environment:
        value: ${{ jobs.defaults.outputs.environment }}
      arch:
        value: ${{ jobs.defaults.outputs.arch }}
      package_prefix:
        value: ${{ jobs.defaults.outputs.package_prefix }}
      major_version:
        value: ${{ jobs.defaults.outputs.major_version }}

env:
  msys_toolchain: "clang"
  msys_prefix: "mingw-w64"

jobs:
  defaults:
    name: 'ðŸŒ Setup Environment Variables'
    runs-on: ubuntu-latest
    outputs:
      github_tag: ${{ steps.input-defaults.outputs.github_tag }}
      build_type: ${{ steps.input-defaults.outputs.build_type }}
      link_type: ${{ steps.input-defaults.outputs.link_type }}
      msystem: ${{ steps.input-defaults.outputs.msystem }}
      environment: ${{ steps.input-defaults.outputs.environment }}
      major_version: ${{ steps.major-version.outputs.major_version }}
      arch: ${{ steps.msys-defaults.outputs.arch }}
      package_prefix: ${{ steps.msys-defaults.outputs.package_prefix }}
    steps:
      - name: 'ðŸ›’ Checkout'
        uses: actions/checkout@v5
      - name: 'ðŸ—ºï¸ Map Workflow Inputs to Output Variables'
        id: input-defaults
        shell: bash
        run: |
          # echo "Sets up default values when triggered from a push"
          temp_build_type="${{ inputs.build_type || 'essentials' }}"
          echo "build_type=${temp_build_type}" >> $GITHUB_OUTPUT

          temp_link_type="${{ inputs.link_type || 'shared' }}"
          echo "link_type=${temp_link_type} " >> $GITHUB_OUTPUT

          temp_msystem="${{ inputs.msystem || 'CLANGARM64' }}"
          echo "msystem=${temp_msystem}" >> $GITHUB_OUTPUT

          temp_environment="${{ inputs.environment || 'base' }}"
          echo "environment=${temp_environment}" >> $GITHUB_OUTPUT

          if [ "${{ inputs.github_tag }}" == "" ]; then
            curl -O https://raw.githubusercontent.com/FFmpeg/FFmpeg/refs/heads/master/RELEASE
            version=$(<RELEASE)
            echo "version from latest:" $version"
          else
            version="${{ inputs.github_tag }}"
            echo "version from github_tag:" $version"
          fi
          if [[ "$version" =~ ([0-9]+) ]]; then
              major_version="${BASH_REMATCH[1]}"
              echo "Major version: $major_version"
          fi
          echo "version:" $version"
          echo "github_tag=${version}" >> $GITHUB_OUTPUT
          echo "major_version=${major_version}" >> $GITHUB_OUTPUT
      - name: 'ðŸ—ºï¸ Map Toolchain Architecture Name'
        id: msys-defaults
        shell: bash
        run: |
          prefix="${msys_prefix}-${msys_toolchain}"
          if [[ ${{ steps.input-defaults.outputs.msystem }} == "CLANGARM64" ]]; then
              echo "arch=aarch64" >> $GITHUB_OUTPUT
              echo "package_prefix=${prefix}-aarch64" >> $GITHUB_OUTPUT
          elif [[ ${{ steps.input-defaults.outputs.msystem }} == "CLANG64" ]]; then
              echo "arch=x86_64" >> $GITHUB_OUTPUT
              echo "package_prefix=${prefix}-x86_64" >> $GITHUB_OUTPUT
          fi
