name: ffmpeg-win-arm64 automated builds

on:
  workflow_dispatch:
    inputs:
      github_tag:
        description: 'Version Tag to build'
        required: true
        default: "n8.0.1"
        type: string
      build_type:
        description: 'Build type of executable'
        required: true
        default: 'essentials'
        type: choice
        options:
        - essentials
        - full
        - both
      link_type:
        description: 'Link type of libraries'
        required: true
        default: 'shared'
        type: choice
        options:
        - shared
        - static
      msystem:
        description: 'MSYS2 System Environment'
        required: true
        default: 'CLANGARM64'
        type: choice
        options:
        - CLANG64
        - CLANGARM64
      environment:
        description: 'Deploy Environment'
        required: true
        default: 'base'
        type: environment
  push:
    paths-ignore:
      - '**.md'
      - '.vscode/**'
      # - '.github/**'
      - '.devcontainer/**'
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  inputs_github_tag: "n8.0.1"
  inputs_build_type: "essentials"
  inputs_link_type: "shared"
  inputs_msystem: 'CLANGARM64'
  inputs_environment: 'base'
  msys_prefix: 'mingw-w64'
  toolchain_arch: 'clang-aarch64'
  package_prefix: 'mingw-w64-clang-aarch64'
  source_repo: "https://github.com/FFmpeg/FFmpeg"
  source_version: "0"

jobs:
  setup-defaults:
    name: 'üåê Setup Environment Variables'
    runs-on: ubuntu-latest
    environment: 'base'
    permissions:
      contents: write
    steps:
      - name: 'üó∫Ô∏è Map Workflow Inputs to Environment Variables'
        shell: bash
        run: |
          github_tag="${{ inputs.github_tag || 'n8.0.1' }}"
          echo "inputs_github_tag=$github_tag" >> $GITHUB_ENV

          build_type="${{ inputs.build_type || 'essentials' }}"
          echo "inputs_build_type=$build_type" >> $GITHUB_ENV

          link_type="${{ inputs.link_type || 'shared' }}"
          echo "inputs_link_type=$link_type " >> $GITHUB_ENV

          msystem="${{ inputs.msystem || 'CLANGARM64' }}"
          echo "inputs_msystem=$msystem" >> $GITHUB_ENV

          environment="${{ inputs.environment || 'CLANGARM64' }}"
          echo "inputs_environment=$environment" >> $GITHUB_ENV
      - name: 'üó∫Ô∏è Map Toolchain Architecture Name'
        shell: bash
        run: |
          if [[ ${inputs_msystem} == "CLANGARM64" ]]; then
              echo "toolchain_arch=clang-aarch64" >> $GITHUB_ENV
          elif [[ ${inputs_msystem} == "CLANG64" ]]; then
              echo "toolchain_arch=clang-x86_64" >> $GITHUB_ENV
          fi
  clone-source:
    name: "üåÄ Clone Source"
    runs-on: ubuntu-latest
    environment: 'base'
    steps:
      - name: "üå™Ô∏è Clone FFmpeg source repository"
        shell: bash
        run: |
          mkdir source
          # git clone --branch $inputs_github_tag $source_repo ./source
          # cd source
          # if test -f "release"; then
          #   version=$(<release)
          #   echo "source_version=$version" >> $GITHUB_ENV
          # else
          #   echo "release version not found"
          #   exit 1
          # fi
  download-external-packages:
    name: "‚¨áÔ∏è Download External Packages"
    runs-on: ubuntu-latest
    environment: 'base'
    steps:
      - uses: actions/checkout@v5
      - id: download-external-packages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd $GITHUB_WORKSPACE
          mkdir downloads
          # gh release download "${toolchain_arch}" -D "${GITHUB_WORKSPACE}/downloads" -R tordona/mingw-packages
          # cd downloads
  download-external-utilities:
    name: "‚¨áÔ∏è Download External Helpers"
    runs-on: ubuntu-latest
    environment: 'base'
    steps:
      - uses: actions/checkout@v5
      - id: download-external-utilities
        run: |
          cd $GITHUB_WORKSPACE
          mkdir utilities
          # gh release download "${toolchain_arch}" -D "${GITHUB_WORKSPACE}/utilities" -R tordona/mingw-packages
          # cd downloads
  # msys2:
    name: '‚öíÔ∏è Setup MSYS2 Environment'
    needs: ['setup-defaults', 'clone-source', 'download-external-packages']
    runs-on: windows-11-arm
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - name: 'üîß Setup MSYS2'
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ env.inputs_msystem }}
        update: true
        cache: true
        release: true
        install:
            git
            make
        pacboy:
            toolchain:p
            gcc-compat:p
            jq:p
    - uses: actions/checkout@v5
    - name: "install-base-packages"
      working-directory: ./config
      run: |
        echo "Install base level packages for Generic build"
        packages=$(jq -r '.options.base.extras | map(.package) | join(",")' options.json)
        echo $package_prefix-{$packages}
    - name: "install-essentials-packages"
      working-directory: ./config
      run: |
        echo "Install base level packages for Essentials Release build"
        packages=$(jq -r '.options.essentials.base | map(.package) | join(",")' options.json)
        echo $package_prefix-{$packages}
    - name: "install-full-packages"
      working-directory: ./config
      run: |
        echo "Install base level packages for Full Release build"
        packages=$(jq -r '.options.full.base | map(.package) | join(",")' options.json)
        echo $package_prefix-{$packages}
  # setup-toolchain-info:
  #   needs: ['msys2', 'clone-source']
  #   name: 'Setup Environment Toolchain'
  #   runs-on: windows-11-arm
  #   steps:
  #     - uses: actions/checkout@v5
  #     - uses: msys2/setup-msys2@v2
  #       with:
  #         msystem: ${{ env.inputs_msystem }}
  #         release: false
  #         run: |
  #           packages=$(jq -r '.options.base.extras | map(.package) | join(",")' options.json)
  #           echo $prefix-$toolchain_arch-{$packages}