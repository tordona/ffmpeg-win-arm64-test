name: FFmpeg Windows ARM64 Automated Builds

on:
  workflow_dispatch:
    inputs:
      github_tag:
        description: 'Version tag to build'
        required: false
        default: "n8.0.1"
        type: string
      build_type:
        description: 'Build type of included libraries'
        required: true
        default: 'essentials'
        type: choice
        options:
        - essentials
        - full
      link_type:
        description: 'Link type of libraries'
        required: true
        default: 'shared'
        type: choice
        options:
        - shared
        - static
      msystem:
        description: 'MSYS2 System Environment'
        required: true
        default: 'CLANGARM64'
        type: choice
        options:
        - CLANGARM64
      environment:
        description: 'Deploy Environment'
        required: true
        default: 'base'
        type: environment
  push:
    paths-ignore:
      - '**.md'
      - '.vscode/**'
      # - '.github/**'
      - '.devcontainer/**'
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  msys_toolchain: "clang"
  source_repo: "https://github.com/FFmpeg/FFmpeg"
  git_dist_repo: "https://github.com/tordona/ffmpeg-win-arm64"

jobs:
  defaults:
    name: 'üéûÔ∏è Setup Default Inputs Values'
    uses: ./.github/workflows/defaults.yml
    with:
      github_tag: ${{ inputs.github_tag }}
      build_type: ${{ inputs.build_type }}
      link_type: ${{ inputs.link_type }}
      msystem: ${{ inputs.msystem }}
      environment: ${{ inputs.environment }}
  ffmpeg-baseline:
    name: 'üéûÔ∏è FFmpeg Baseline Configuration'
    needs: ['defaults']
    uses: ./.github/workflows/ffmpeg-baseline.yml
    with:
      msystem: ${{ needs.defaults.outputs.msystem }}
      build_type: ${{ needs.defaults.outputs.build_type }}
      link_type: ${{ needs.defaults.outputs.link_type }}
      major_version: ${{ needs.defaults.outputs.major_version }}
  msys2:
    name: 'üíª MSYS2 Environment'
    runs-on: windows-11-arm
    needs: ['defaults', 'ffmpeg-baseline']
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - name: 'üõí Checkout'
      uses: actions/checkout@v5
    - name: 'üîß Setup MSYS2'
      id: msys2-env
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ needs.defaults.outputs.msystem }}
        update: true
        cache: true
        release: true
        install:
            gcc
            git
            make
        pacboy:
            toolchain:p
            gcc-compat:p
            diffutils:p
            libssh2:p
            jq:p
            github-cli:p
    - name: 'üèÉ‚Äç‚û°Ô∏è Verify MSYS2 Install'
      run: |
        echo "MSYS2 is installed at: ${{ steps.msys2-env.outputs.msys2-location }}"
        command="clang --version"
        eval $command
    - name: 'üå™Ô∏è Clone FFmpeg source repository from Tag'
      if: ${{ github.event.inputs.github_tag != '' }}
      id: 'source-code-tag'
      run: |
        mkdir source
        git -c advice.detachedHead=false clone --branch ${{ needs.defaults.outputs.github_tag }} ${{ env.source_repo }} ./source
    - name: 'üå™Ô∏è Clone FFmpeg source repository from Latest'
      if: ${{ github.event.inputs.github_tag == '' }}
      id: 'source-code-latest'
      run: |
        mkdir source
        git -c advice.detachedHead=false clone ${{ env.source_repo }} ./source
    - name: 'ü™° Create FFmpeg Distribution Configuration Bits'
      id: 'ffmpeg-config-setup'
      uses: ./.github/actions/ffmpeg 
      with:
        github_tag: ${{ needs.defaults.outputs.github_tag }}
        build_type: ${{ needs.defaults.outputs.build_type }}
        link_type: ${{ needs.defaults.outputs.link_type }}
        msystem: ${{ needs.defaults.outputs.msystem }}
        arch: ${{ needs.msys-defaults.outputs.arch }}
        msys_path: ${{ steps.msys2-env.outputs.msys2-location }}
        build_config: ${{ needs.ffmpeg-baseline.outputs.build_config }}
    - name: "üì¶ Install packages - Essentials Build"
      working-directory: ./config
      run: |
        echo "Install required library packages - Essentials Build"
        major_version="${{ needs.defaults.outputs.major_version }}"
        packages=$(jq -r --arg version "$major_version" --arg prefix "${{ needs.defaults.outputs.package_prefix }}"  '[.options.standard[], .options.essentials[] | .[] | select(.version <= $version) | select(.custom != "true") | $prefix + "-" + .package] | join(" ")' options.json)
        echo "$packages"
        pacman -S --disable-download-timeout --noconfirm --overwrite '*' $packages
    - name: "üì¶ Install packages - Full Build"
      if: ${{ needs.defaults.outputs.build_type == 'full' }}
      working-directory: ./config
      run: |
        echo "Install required library packages - Full Build"
        major_version="${{ needs.defaults.outputs.major_version }}"
        packages=$(jq -r --arg version "$major_version" --arg prefix "${{ needs.defaults.outputs.package_prefix }}"  '[.options.full[] | .[] | select(.version <= $version) | select(.custom != "true") | $prefix + "-" + .package] | join(" ")' options.json)
        echo "$packages"
        pacman -S --disable-download-timeout --noconfirm --overwrite '*' $packages
    - name: "‚¨áÔ∏è Download External Packages"
      run: |
       mkdir packages
       gh release download "${{ env.msys_toolchain }}-${{ needs.defaults.outputs.arch }}" --pattern "*.zst" -D "./packages" -R tordona/mingw-packages
    - name: "‚û°Ô∏è Install External Packages"
      run: |
        echo "Install Custom Packages from External Repo"
        cd packages
        pacman -U --disable-download-timeout --overwrite '*' --noconfirm *.pkg.tar.zst
    - name: 'üî® Configure FFmpeg Build'
      continue-on-error: true
      run: |
        echo "Configure FFmpeg Build with Library Options"
        major_version="${{ needs.defaults.outputs.major_version }}}"
        generic_options=$(jq -r '.options.generic | map("--\(.status)-\(.option)") | join(" ")' ./config/options.json)
        ffmpeg_lib_options=$(jq -r --arg version "$major_version" '[.options.standard[], .options.essentials[] | .[] | select(.version <= $version) | "--enable-" + .option] | join(" ")' ./config/options.json)
        if [[ "${{ needs.defaults.outputs.build_type }}" == "full" ]]; then
          ffmpeg_lib_options+=" --extra-cflags=-DLIBTWOLAME_STATIC "
          ffmpeg_lib_options+=$(jq -r --arg version "$major_version" '[.options.full[] | .[] | select(.version <= $version) | "--enable-" + .option] | join(" ")' ./config/options.json)
        fi
        cd source
        command="./configure ${{ steps.ffmpeg-config-setup.outputs.build_config }} ${generic_options} ${ffmpeg_lib_options}"
        echo $command
        eval "$command > ${{ steps.ffmpeg-config-setup.outputs.build_file_ref }}" 
    - name: 'üî® Log: Show FFmpeg Build Config'
      run: |
        log="./source/ffbuild/config.log"
        if [ -f "$log" ]; then
            cat ./source/ffbuild/config.log
        fi
    - name: 'üî® Log: Show FFmpeg Configuration Output'
      run: |
        if test -f "${{ steps.ffmpeg-config-setup.outputs.build_file_ref }}"; then
          echo "$(<${{ steps.ffmpeg-config-setup.outputs.build_file_ref }})"
        fi
    - name: 'ü•ã Modifiy Config Header and readme file'
      run: |
        echo "Remove build distribution specifc configrations"
        path_msys_include="${{ steps.ffmpeg-config-setup.outputs.path_msys_include }}"
        output_path="${{ steps.ffmpeg-config-setup.outputs.output_path }}"
        version_name="${{ steps.ffmpeg-config-setup.outputs.version_name }}"
        build_file_ref="${{ steps.ffmpeg-config-setup.outputs.build_file_ref }}"
        build_type="${{ needs.defaults.outputs.build_type }}"
        link_type="${{ needs.defaults.outputs.link_type }}"
        source_repo="${{ env.source_repo }}"
        git_dist_repo="${{ env.git_dist_repo }}"
        commit=$(git rev-parse HEAD)
        config_file="config.h"

        cd source
        if [[ -f "$config_file" ]]; then
          sed -i "s|\s--extra-cflags=-I$path_msys_include||gI" $config_file
          sed -i "s|\s--extra-cflags='-march=native'||gI" $config_file
          sed -i "s|\s--extra-cflags=-DLIBTWOLAME_STATIC||gI" $config_file
          sed -i "s|\s--extra-cflags=-DMODPLUG_STATIC||gI" $config_file
          sed -i "s|\s--extra-ldflags='-Wl,--allow-multiple-definition'||gI" $config_file
          sed -i "s|\s--disable-manpages||gI" $config_file
          sed -i "s|\s--disable-podpages||gI" $config_file
          sed -i "s|\s--disable-txtpages||gI" $config_file
          sed -i "s|\s--datadir=$output_path\/$version_name\/presets||gI" $config_file
          sed -i "s|\s--prefix=$output_path\/$version_name||gI" $config_file
          sed -i "s|\s--docdir=$output_path\/$version_name\/docs||gI" $config_file
          sed -i "s|\s--libdir=$output_path\/dump\/libs||gI" $config_file
          sed -i "s|\s--incdir=$output_path\/dump\/include||gI" $config_file
          echo "$(<$config_file)"
        fi
        if [[ -f "$build_file_ref" ]]; then
          sed -i -r "/((\w+\/)?(\w+\.\w{1,}){1,} is unchanged)/d" $build_file_ref
          sed -i -r "/^install prefix/d" $build_file_ref
          sed -i "1s|^|release-$build_type-$link_type build configuration\n\n|" $build_file_ref
          sed -i "1s|^|Source Code: $source_repo/commit/$commit\n\n|" $build_file_ref
          sed -i "1s|^|License: GPL v3\n\n|" $build_file_ref
          sed -i "1s|^|Version: $version_name\n\n|" $build_file_ref
          sed -i "1s|^|FFmpeg ARM64 ${build_type^} ${link_type^} Windows Build from $git_dist_repo\n\n|" $build_file_ref
          echo "$(<$build_file_ref)"
        fi
    - name: 'ü™ß Copy Support Files'
      run: |
        echo "Copy support files to output directory"
        output_path="/c/a/ffmpeg-win-arm64-test/ffmpeg-win-arm64-test/builds/ffmpeg-shared"
        version_name="ffmpeg-8.0.git-essentials-shared-win-arm64"
        build_file_ref="essentials-shared.txt"
        if [[ ! -d "$output_path/$version_name" ]] then
          mkdir -p "$output_path/$version_name"
        fi
        if [[ -f "./source/$build_file_ref" ]]; then
          cp "./source/$build_file_ref" "$output_path/$version_name/readme.txt"
          echo "copied $build_file_ref out to readme.txt"
        fi
        if [[ -f "./source/COPYING.GPLv3" ]]; then
          echo "exists COPYING.GPLv3"
          cp "./source/COPYING.GPLv3" "$output_path/$version_name/license"
          echo "copied $build_file_ref out to license"
        fi
    - name: 'üñ•Ô∏è Get number of CPU cores'
      uses: SimenB/github-actions-cpu-cores@v2
      id: 'cpu-cores'
    - name: 'üç≥ Trigger Make Command'
      id: 'make-ffmpeg'
      run: |
        cd source
        make -j${{ steps.cpu-cores.outputs.count }}
    - name: 'üè≠ Trigger Install Command'
      id: 'install-ffmpeg'
      run: |
        cd source
        make install -j${{ steps.cpu-cores.outputs.count }}
    - name: 'üì§ Upload artifact: package'
      uses: actions/upload-artifact@v6
      with:
        if-no-files-found: error
        name: ${{ steps.ffmpeg-config-setup.outputs.version_name }}
        path: |
          ./builds/**/*.*
  distro:
    name: 'üíª Distro Packager'
    runs-on: windows-11-arm
    needs: ['msys2']
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
    - name: "‚¨áÔ∏è Download External Utlities"
      run: |
        mkdir utilities
        cd utilities
        curl -LO https://github.com/tordona/win-arm64-binaries/releases/download/rcedit/rcedit-v2.0-win-arm64.7z
        7z x *.7z
        pwd
        cp rcedit.exe ../**/**/bin/*.*
    - uses: actions/download-artifact@v5
      with:
        path: ./
    - name: 'Cleanup Files'
      id: 'files'
      shell: bash
      run: |
        cd **
        rm -rf dump
        cd **
        find . -type f -name '*.lib' -delete
        find . -type f -name '*.xsd' -delete
        rm -rf ./presets/examples
        temp_name=$(basename $(pwd))
        echo "package_name=${temp_name}" >> $GITHUB_OUTPUT
    - name: 'Resource Versioning'
      shell: bash
      run: |
        echo "resource_versioning"
        cd **/**/bin        
        file_version=$(date '+%Y.%m.%d.0')
        copyright="Copyright ¬© 2000-$(date '+%Y') the FFmpeg developers"
        ffmpeg_desc="A command line tool to convert multimedia files between formats"
        ffplay_desc="A simple media player based on SDL and the FFmpeg libraries"
        ffprobe_desc="A simple multimedia stream analyzer"

        ff_progs=(
          "ffmpeg"
          "ffplay"
          "ffprobe"
        )

        for ff in "${ff_progs[@]}"; do
          desc=$ff
          desc+="_desc"
          if [[ -f "${ff}.exe" ]]; then
            product_prefix=${ff:0:2}
            product_suffix=${ff:2}
            if ![[ -f "${ff}.exe.bak" ]]; then
              cp ${ff}.exe ${ff}.exe.bak
            fi
            rcedit.exe ${ff}.exe --set-version-string "FileDescription" "${!desc}"
            rcedit.exe ${ff}.exe --set-file-version "${file_version}"
            rcedit.exe ${ff}.exe --set-version-string "ProductName" "${product_prefix^^}${product_suffix}"
            rcedit.exe ${ff}.exe --set-version-string "ProductVersion" "${version}"
            rcedit.exe ${ff}.exe --set-version-string "LegalCopyright" "${copyright}"            
            if [[ -f "${ff}.ico" ]]; then
              rcedit.exe ${ff}.exe --set-icon ${ff}.ico
            fi
            rm *.exe.bak
            rm rcedit.exe
          fi
        done
    - name: 'Package'
      shell: bash
      run: |
        cd **/**
        pwd
        ls -la
        for dir in ffmpeg**; do
          filename=$(dir)
          7z a $filename.7z $filename
        done
    - name: 'Package'
      shell: bash
      run: |
        cd **/**
        7z a $${{ steps.files.outputs.package_name }}.7z ${{ steps.files.outputs.package_name }}
    - name: 'üì§ Upload artifact: package'
      uses: actions/upload-artifact@v6
      with:
        if-no-files-found: error
        name: ${{ steps.files.outputs.package_name }}
        path: |
          ./**/${{ steps.files.outputs.package_name }}.7z
