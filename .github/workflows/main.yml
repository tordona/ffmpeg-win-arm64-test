name: ffmpeg-win-arm64 automated builds

on:
  workflow_dispatch:
    inputs:
      github_tag:
        description: 'Version Tag to build'
        required: true
        default: "n8.0.1"
        type: string
      build_type:
        description: 'Build type of executable'
        required: true
        default: 'essentials'
        type: choice
        options:
        - essentials
        - full
      link_type:
        description: 'Link type of libraries'
        required: true
        default: 'shared'
        type: choice
        options:
        - shared
        - static
      msystem:
        description: 'MSYS2 System Environment'
        required: true
        default: 'CLANGARM64'
        type: choice
        options:
        - CLANG64
        - CLANGARM64
      environment:
        description: 'Deploy Environment'
        required: true
        default: 'base'
        type: environment
  push:
    paths-ignore:
      - '**.md'
      - '.vscode/**'
      # - '.github/**'
      - '.devcontainer/**'
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  msys_prefix: "mingw-w64"
  source_repo: "https://github.com/FFmpeg/FFmpeg"
  
  inputs_github_tag: "n8.0.1"
  inputs_build_type: "essentials"
  inputs_link_type: "full"
  inputs_msystem: 'CLANGARM64'
  
  arch: "aarch64"
  toolchain_arch: "clang-aarch64"
  package_prefix: "mingw-w64-clang-aarch64"


jobs:
  defaults:
    name: 'ğŸŒ Setup Environment Variables'
    runs-on: ubuntu-latest
    outputs:
      github_tag: ${{ steps.env-defaults.outputs.github_tag }}
      build_type: ${{ steps.env-defaults.outputs.build_type }}
      link_type: ${{ steps.env-defaults.outputs.link_type }}
      msystem: ${{ steps.env-defaults.outputs.msystem }}
      environment: ${{ steps.env-defaults.outputs.environment }}
    steps:
      - name: 'ğŸ›’ Checkout'
        uses: actions/checkout@v5
      - name: 'ğŸ—ºï¸ Map Workflow Inputs to Environment Variables'
        id: env-defaults
        shell: bash
        run: |
          temp_github_tag="${{ inputs.github_tag || 'n8.0.1' }}"
          echo "github_tag=${temp_github_tag}" >> $GITHUB_ENV

          temp_build_type="${{ inputs.build_type || 'essentials' }}"
          echo "build_type=${temp_build_type}" >> $GITHUB_ENV

          temp_link_type="${{ inputs.link_type || 'shared' }}"
          echo "link_type=${temp_link_type} " >> $GITHUB_ENV

          temp_msystem="${{ inputs.msystem || 'CLANGARM64' }}"
          echo "msystem=${temp_msystem}" >> $GITHUB_ENV

          temp_environment="${{ inputs.environment || 'base' }}"
          echo "environment=${temp_environment}" >> "$GITHUB_OUTPUT"
      - name: 'ğŸ—ºï¸ Map Toolchain Architecture Name'
        shell: bash
        run: |
          if [[ ${{ env.inputs_msystem }} == "CLANGARM64" ]]; then
              echo "arch=aarch64" >> $GITHUB_ENV
              echo "toolchain_arch=clang-aarch64" >> $GITHUB_ENV
              echo "package_prefix=${{ env.msys_prefix }}-clang-aarch64" >> $GITHUB_ENV
          elif [[ ${{ env.inputs_msystem }} == "CLANG64" ]]; then
              echo "arch=x86_64" >> $GITHUB_ENV
              echo "toolchain_arch=clang-x86_64" >> $GITHUB_ENV
              echo "package_prefix=${{ env.msys_prefix }}-clang-x86_64" >> $GITHUB_ENV
          fi
 

  # setup-ffmpeg-options:
  #   name: 'ğŸï¸ Setup FFmpeg Configuration'
  #   runs-on: ubuntu-latest
  #   outputs:
  #     ffmpeg-config: ${{ env.build_config }}
  #   env:
  #     build_config: "./configure "
  #   steps:
  #   - name: 'ğŸ›’ Checkout'
  #     uses: actions/checkout@v5
  #   - name: 'ğŸ—ºï¸ Setup FFmpeg Baseline Configuration'
  #     working-directory: ./config
  #     run: |
  #       base_config=$(jq -r '.config' options.json)
  #       echo "build_config=${base_config}" >> $GITHUB_ENV
  #   - name: 'ğŸ›ï¸ Set Target Architecture'
  #     run: |
  #       echo "Set Explict Architecture Option Value"
  #       if [[ ${{ env.inputs_msystem }} == "CLANGARM64" ]]; then
  #         temp_config=" --arch=aarch64"
  #       elif [[ ${{ env.inputs_msystem }} == "CLANG64" ]]; then
  #         temp_config="--arch=x86_64"
  #       fi
  #       echo "build_config=$build_config$temp_config" >> $GITHUB_ENV
  #   - name: 'ğŸ”— Set Link Type'
  #     run: |
  #       if [[ ${{ env.inputs_link_type }} == "shared" ]]; then
  #         temp_config=" --enable-shared --disable-static"
  #       else
  #         temp_config=" --disable-shared --enable-static"
  #       fi
  #       echo "build_config=$build_config$temp_config" >> $GITHUB_ENV
  #   - name: 'ğŸ´ Set Compile LDFLAGS'
  #     working-directory: ./config
  #     run: |
  #       if [[ ${{ env.inputs_github_tag }} =~ ([0-9]+) ]]; then
  #         major_version="${BASH_REMATCH[1]}"
  #         options=$(jq -r --arg version $major_version '[.options.standard[], .options.essentials[], .options.full[] | .[] | select(.version <= $version) | .option] | join(" ")' options.json)
  #         echo $options
  #         if [[ "$options" == *"librav1e"* && "$options" == *"libplacebo"* ]]; then
  #           temp_config=" --extra-ldflags='-Wl,--allow-multiple-definition"
  #           echo "build_config=$build_config$temp_config" >> $GITHUB_ENV
  #         fi
  #       fi
  #   - name: 'ğŸ¬ Echo Configuration'
  #     id: 'ffmpeg-config'
  #     run: |
  #       echo $build_config
  setup-test:
    name: 'ğŸŒ Setup Environment Variabless'
    runs-on: ubuntu-latest
    needs: ['defaults']
    steps:
      - name: test
        run: |
          echo "${{ needs.defaults.outputs.github_tag }}"
          echo "${{ needs.defaults.outputs.build_type }}"
          echo "${{ needs.defaults.outputs.link_type }}"
          echo "${{ needs.defaults.outputs.msystem }}"
          echo "${{ needs.defaults.outputs.environment }}"
  # msys2:
  #   name: 'ğŸ’» MSYS2 Environment'
  #   runs-on: windows-11-arm
  #   needs: ['setup-defaults']
  #   env:
  #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #   defaults:
  #     run:
  #       shell: msys2 {0}
  #   steps:
  #   - name: 'ğŸ›’ Checkout'
  #     uses: actions/checkout@v5
  #   - name: 'ğŸ”§ Setup MSYS2'
  #     id: msys2-setup
  #     uses: msys2/setup-msys2@v2
  #     with:
  #       msystem: ${{ inputs.msystem || 'CLANGARM64' }}
  #       update: true
  #       cache: true
  #       release: true
  #       install:
  #           gcc
  #           git
  #           make
  #       pacboy:
  #           toolchain:p
  #           gcc-compat:p
  #           diffutils:p
  #           libssh2:p
  #           jq:p
  #           github-cli:p
  #   - name: 'Verify MSYS2 Install'
  #     run: |
  #       echo "MSYS2 is installed at: ${{ steps.msys2-setup.outputs.msys2-location }}"
  #   - name: "ğŸŒªï¸ Clone FFmpeg source repository"
  #     run: |
  #       mkdir source
  #       git -c advice.detachedHead=false clone --branch $inputs_github_tag $source_repo ./source
  #       cd source
  #       if test -f "RELEASE"; then
  #         version=$(<RELEASE)
  #         echo "source_version=$version" >> $GITHUB_ENV
  #       else
  #         echo "Release Version Not Found"
  #         exit 1
  #       fi
  #   - name: "ğŸ“¦ Install packages - Essentials Build"
  #     working-directory: ./config
  #     run: |
  #       echo "Install required library packages - Essentials Build
  #       packages=$(jq -r --arg version "$source_version" --arg prefix "$package_prefix"  '[.options.standard[], .options.essentials[] | .[] | select(.version <= $version) | $prefix + "-" + .package] | join(" ")' options.json)
  #       echo "$packages"
  #       pacman -S --noconfirm --overwrite '*' "$packages"
  #   - name: "ğŸ“¦ Install base level packages - Full Build"
  #     if: ${{ env.inputs_build_type == 'full' }}
  #     working-directory: ./config
  #     run: |
  #       echo "Install required library packages - Full Build
  #       packages=$(jq -r --arg version "$source_version" --arg prefix "$package_prefix"  '[.options.full[] | .[] | select(.version <= $version) | $prefix + "-" + .package] | join(" ")' options.json)
  #       echo $packages
  #       pacman -S --noconfirm --overwrite '*' "$packages"
  #   - name: "â¬‡ï¸ Download External Packages"
  #     run: |
  #      mkdir packages
  #      gh release download "${toolchain_arch}" --pattern "*.zst" -D "./packages" -R tordona/mingw-packages
  #   - name: "â¡ï¸ Install External Packages"
  #     run: |
  #       echo "Install Custom Packages from External Repo"
  #       cd packages
  #       pacman -U --overwrite '*' --noconfirm *.pkg.tar.zst
  #   # - name: "â¬‡ï¸ Download External Utlities"
  #   #   run: |
  #   #     mkdir utilities
  #   #     gh release download "rcedit" -D "./utilities" -R tordona/win-arm64-binaries
  #   #     cd utilities
  #   #     ls -la
  #   - uses: hmarr/debug-action@v3
  #   - name: "ğŸ”¨ Test: Configure FFmpeg"
  #     continue-on-error: true
  #     run: |
  #       echo "Test tooling and library availability"
  #       echo "MSYS2 is installed at: ${{ steps.msys2-setup.outputs.msys2-location }}"
  #       cd source
  #       # echo "$env:MSYS2_LOCATION"
  #       # extra="--extra-libs='-static -lpthread -lm -liconv'"
  #       # arch="--arch=${toolchain_arch##clang\-}"
  #       # generic_options=$(jq -r '.options.generic | map("--\(.status)-\(.option)") | join(" ")' ../config/options.json)
  #       # essential_base_options=$(jq -r '.options.essentials.base | map("--enable-\(.option)") | join(" ")' ../config/options.json)
  #       # essential_external_options=$(jq -r '.options.essentials.external | map("--enable-\(.option)") | join(" ")' ../config/options.json)
  #       # essential_dependent_options=$(jq -r '.options.essentials.dependent | map("--enable-\(.option)") | join(" ")' ../config/options.json)
  #       # command="./configure $extra $arch --enable-shared --disable-static $generic_options $essential_base_options $essential_external_options $essential_dependent_options"
  #       echo $command
  #       eval $command
  #   - name: "ğŸ”¨ Test: Configure FFmpeg"
  #     run: |
  #       echo "Test tooling and library availability"
  #       cd source
  #       cd ffbuild
  #       cat config.log
  #   # - name: 'ğŸ–¥ï¸ Get number of CPU cores'
  #   #   uses: SimenB/github-actions-cpu-cores@v2
  #   #   id: cpu-cores
  #   # - name: "ğŸ”¨ Test: Configure FFmpeg"
  #   #   run: |
  #   #     echo "Test tooling and library availability"
  #   #     cd source
  #   #     make -j${{ steps.cpu-cores.outputs.count }}
  #   # - name: "ğŸ”¨ Test: Configure FFmpeg"
  #   #   run: |
  #   #     echo "Test tooling and library availability"
  #   #     cd source/ffbuild
  #   #     cat config.log