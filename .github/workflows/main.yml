name: FFmpeg Windows ARM64 Automated Builds

on:
  workflow_dispatch:
    inputs:
      github_tag:
        description: 'Version tag to build'
        required: true
        default: "n8.0.1"
        type: string
      build_type:
        description: 'Build type of included libraries'
        required: true
        default: 'essentials'
        type: choice
        options:
        - essentials
        - full
      link_type:
        description: 'Link type of libraries'
        required: true
        default: 'shared'
        type: choice
        options:
        - shared
        - static
      msystem:
        description: 'MSYS2 System Environment'
        required: true
        default: 'CLANGARM64'
        type: choice
        options:
        - CLANGARM64
      environment:
        description: 'Deploy Environment'
        required: true
        default: 'base'
        type: environment
  push:
    paths-ignore:
      - '**.md'
      - '.vscode/**'
      # - '.github/**'
      - '.devcontainer/**'
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  msys_toolchain: "clang"
  source_repo: "https://github.com/FFmpeg/FFmpeg"

jobs:
  defaults:
    name: 'ğŸï¸ Setup Default Inputs Values'
    uses: ./.github/workflows/defaults.yml
    with:
      github_tag: ${{ inputs.github_tag }}
      build_type: ${{ inputs.build_type }}
      link_type: ${{ inputs.link_type }}
      msystem: ${{ inputs.msystem }}
      environment: ${{ inputs.environment }}
  ffmpeg-baseline:
    name: 'ğŸï¸ FFmpeg Baseline Configuration'
    needs: ['defaults']
    uses: ./.github/workflows/ffmpeg-baseline.yml
    with:
      msystem: ${{ needs.defaults.outputs.msystem }}
      build_type: ${{ needs.defaults.outputs.build_type }}
      link_type: ${{ needs.defaults.outputs.link_type }}
      major_version: ${{ needs.defaults.outputs.major_version }}
  # msys2:
  #   name: 'ğŸ’» MSYS2 Environment'
  #   runs-on: windows-11-arm
  #   needs: ['defaults', 'ffmpeg-baseline']
  #   env:
  #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #   defaults:
  #     run:
  #       shell: msys2 {0}
  #   steps:
  #   - name: 'ğŸ›’ Checkout'
  #     uses: actions/checkout@v5
  #   - name: 'ğŸ”§ Setup MSYS2'
  #     id: msys2-env
  #     uses: msys2/setup-msys2@v2
  #     with:
  #       msystem: ${{ needs.defaults.outputs.msystem }}
  #       update: true
  #       cache: true
  #       release: true
  #       install:
  #           gcc
  #           git
  #           make
  #       pacboy:
  #           toolchain:p
  #           gcc-compat:p
  #           diffutils:p
  #           libssh2:p
  #           jq:p
  #           github-cli:p
  #   - name: 'ğŸƒâ€â¡ï¸ Verify MSYS2 Install'
  #     run: |
  #       echo "MSYS2 is installed at: ${{ steps.msys2-env.outputs.msys2-location }}"
  #       command="clang --version"
  #       eval $command
  #   - name: 'ğŸŒªï¸ Clone FFmpeg source repository'
  #     id: 'source-code'
  #     run: |
  #       mkdir source
  #       git -c advice.detachedHead=false clone --branch ${{ needs.defaults.outputs.github_tag }} $source_repo ./source
  #   - name: 'ğŸª¡ Create FFmpeg config pieces'
  #     id: 'ffmpeg-config-setup'
  #     uses: ./.github/actions/ffmpeg 
  #     with:
  #       version: ${{ needs.defaults.outputs.github_tag }}
  #       build_type: ${{ needs.defaults.outputs.build_type }}
  #       link_type: ${{ needs.defaults.outputs.link_type }}
  #       msystem: ${{ needs.defaults.outputs.msystem }}
  #       arch: ${{ needs.msys-defaults.outputs.arch }}
  #       msys_path: ${{ steps.msys2-env.outputs.msys2-location }}
  #       build_config: ${{ needs.ffmpeg-baseline.outputs.build_config }}
  #   - name: "ğŸ“¦ Install packages - Essentials Build"
  #     working-directory: ./config
  #     run: |
  #       echo "Install required library packages - Essentials Build"
  #       major_version="${{ steps.source-code.outputs.major_version }}"
  #       packages=$(jq -r --arg version "$major_version" --arg prefix "${{ needs.defaults.outputs.package_prefix }}"  '[.options.standard[], .options.essentials[] | .[] | select(.version <= $version) | select(.custom != "true") | $prefix + "-" + .package] | join(" ")' options.json)
  #       echo "$packages"
  #       pacman -S --disable-download-timeout --noconfirm --overwrite '*' $packages
  #   - name: "ğŸ“¦ Install packages - Full Build"
  #     if: ${{ needs.defaults.outputs.build_type == 'full' }}
  #     working-directory: ./config
  #     run: |
  #       echo "Install required library packages - Full Build"
  #       major_version="${{ steps.source-code.outputs.major_version }}"
  #       packages=$(jq -r --arg version "$major_version" --arg prefix "${{ needs.defaults.outputs.package_prefix }}"  '[.options.full[] | .[] | select(.version <= $version) | select(.custom != "true") | $prefix + "-" + .package] | join(" ")' options.json)
  #       echo "$packages"
  #       pacman -S --disable-download-timeout --noconfirm --overwrite '*' $packages
  #   - name: "â¬‡ï¸ Download External Packages"
  #     run: |
  #      mkdir packages
  #      gh release download "${{ env.msys_toolchain }}-${{ needs.defaults.outputs.arch }}" --pattern "*.zst" -D "./packages" -R tordona/mingw-packages
  #   - name: "â¡ï¸ Install External Packages"
  #     run: |
  #       echo "Install Custom Packages from External Repo"
  #       cd packages
  #       pacman -U --disable-download-timeout --overwrite '*' --noconfirm *.pkg.tar.zst
  #   - name: "â¬‡ï¸ Download External Utlities"
  #     run: |
  #       mkdir utilities
  #       gh release download "rcedit" -D "./utilities" -R tordona/win-arm64-binaries
  #       cd utilities
  #       ls -la
  #   - uses: hmarr/debug-action@v3
  #   - name: 'ğŸ”¨ Configure FFmpeg Build'
  #     continue-on-error: true
  #     run: |
  #       echo "Configure FFmpeg Build with Library Options"
  #       major_version="${{ steps.source-code.outputs.major_version }}"
  #       generic_options=$(jq -r '.options.generic | map("--\(.status)-\(.option)") | join(" ")' ./config/options.json)
  #       ffmpeg_lib_options=$(jq -r --arg version "$major_version" '[.options.standard[], .options.essentials[] | .[] | select(.version <= $version) | "--enable-" + .option] | join(" ")' ./config/options.json)
  #       if [[ "${{ needs.defaults.outputs.build_type }}" == "full" ]]; then
  #         ffmpeg_lib_options+=" "
  #         ffmpeg_lib_options+=$(jq -r --arg version "$major_version" '[.options.full[] | .[] | select(.version <= $version) | "--enable-" + .option] | join(" ")' ./config/options.json)
  #       fi
  #       cd source
  #       command="./configure ${{ steps.ffmpeg-config-setup.outputs.build_config }} ${generic_options} ${ffmpeg_lib_options}"
  #       echo $command
  #       eval "$command > ${{ steps.ffmpeg-config-setup.outputs.build_file_ref }}" 
  #   - name: 'ğŸ”¨ Log: Show FFmpeg Build Config'
  #     run: |
  #       log="./source/ffbuild/config.log"
  #       if [ -f "$log" ]; then
  #           cat ./source/ffbuild/config.log
  #       fi
  #   - name: 'ğŸ”¨ Log: Show FFmpeg Configuration Output'
  #     run: |
  #       if test -f "${{ steps.ffmpeg-config-setup.outputs.build_file_ref }}"; then
  #         echo "$(<${{ steps.ffmpeg-config-setup.outputs.build_file_ref }})"
  #       fi
  #   - name: 'ğŸ–¥ï¸ Get number of CPU cores'
  #     uses: SimenB/github-actions-cpu-cores@v2
  #     id: 'cpu-cores'
  #   - name: 'ğŸ³ Trigger Make Command'
  #     id: 'make-ffmpeg'
  #     run: |
  #       if [[ "${{ needs.defaults.outputs.build_type }}" == "full" ]]; then
  #         export CFLAGS=-DLIBTWOLAME_STATIC
  #       fi
  #       cd source
  #       make -j${{ steps.cpu-cores.outputs.count }}
  #   - name: 'ğŸ­ Trigger Install Command'
  #     id: 'install-ffmpeg'
  #     run: |
  #       cd source
  #       make install
  #       cd ${{ steps.ffmpeg-config-setup.outputs.output_path }}
  #   - name: 'ğŸ“¤ Upload artifact: package'
  #     uses: actions/upload-artifact@v6
  #     with:
  #       if-no-files-found: error
  #       name: ${{ steps.ffmpeg-config-setup.outputs.version_name }}
  #       path: |
  #         ./builds/**/*.*
