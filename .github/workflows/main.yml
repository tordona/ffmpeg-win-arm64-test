name: ffmpeg-win-arm64 automated builds

on:
  workflow_dispatch:
    inputs:
      github_tag:
        description: 'Version Tag to build'
        required: true
        default: "n8.0.1"
        type: string
      build_type:
        description: 'Build type of executable'
        required: true
        default: 'essentials'
        type: choice
        options:
        - essentials
        - full
        - both
      link_type:
        description: 'Link type of libraries'
        required: true
        default: 'shared'
        type: choice
        options:
        - shared
        - static
      msystem:
        description: 'MSYS2 System Environment'
        required: true
        default: 'CLANGARM64'
        type: choice
        options:
        - CLANG64
        - CLANGARM64
      environment:
        description: 'Deploy Environment'
        required: true
        default: 'base'
        type: environment
  push:
    paths-ignore:
      - '**.md'
      - '.vscode/**'
      # - '.github/**'
      - '.devcontainer/**'
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  inputs_github_tag: "n8.0.1"
  inputs_build_type: "essentials"
  inputs_link_type: "shared"
  inputs_msystem: 'CLANGARM64'
  inputs_environment: "base"
  arch: "aarch64"
  msys_prefix: "mingw-w64"
  toolchain_arch: "clang-aarch64"
  package_prefix: "mingw-w64-clang-aarch64"
  source_repo: "https://github.com/FFmpeg/FFmpeg"
  source_version: "0"

jobs:
  setup-defaults:
    name: 'üåê Setup Environment Variables'
    runs-on: ubuntu-latest
    environment: 'base'
    steps:
      - name: 'üó∫Ô∏è Map Workflow Inputs to Environment Variables'
        shell: bash
        run: |
          github_tag="${{ inputs.github_tag || 'n8.0.1' }}"
          echo "inputs_github_tag=${github_tag}" >> $GITHUB_ENV

          build_type="${{ inputs.build_type || 'essentials' }}"
          echo "inputs_build_type=${build_type}" >> $GITHUB_ENV

          link_type="${{ inputs.link_type || 'shared' }}"
          echo "inputs_link_type=${link_type} " >> $GITHUB_ENV

          msystem="${{ inputs.msystem || 'CLANGARM64' }}"
          echo "inputs_msystem=${msystem}" >> $GITHUB_ENV

          environment="${{ inputs.environment || 'CLANGARM64' }}"
          echo "inputs_environment=${environment}" >> $GITHUB_ENV
      - name: 'üó∫Ô∏è Map Toolchain Architecture Name'
        shell: bash
        run: |
          if [[ ${inputs_msystem} == "CLANGARM64" ]]; then
              echo "toolchain_arch=clang-aarch64" >> $GITHUB_ENV
              echo "package_prefix=${msys_prefix}-clang-aarch64" >> $GITHUB_ENV
          elif [[ ${inputs_msystem} == "CLANG64" ]]; then
              echo "toolchain_arch=clang-x86_64" >> $GITHUB_ENV
              echo "package_prefix=${msys_prefix}-clang-x86_64" >> $GITHUB_ENV
          fi
      - name: 'üó∫Ô∏è Verify Environment Variables'
        shell: bash
        run: |
          echo $inputs_environment
  msys2:
    name: 'üíª MSYS2 Environment'
    runs-on: windows-11-arm
    needs: ['setup-defaults']
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - name: 'üîß Setup MSYS2'
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ env.inputs_msystem }}
        update: true
        cache: true
        release: true
        install:
            git
            make
        pacboy:
            toolchain:p
            gcc-compat:p
            diffutils:p
            jq:p
            github-cli:p
            python-lxml:p
        run: echo "$env:MSYS2_LOCATION"
    - name: 'test'
      env:
        MSYS2_LOCATION: ${{ steps.msys2.outputs.msys2-location }}
      run: |
        echo ${{ steps.msys2.outputs.msys2-location }}
        echo $MSYS2_LOCATION
        echo "$MSYS2_LOCATION"
    - name: 'üõí Checkout'
      uses: actions/checkout@v5
    - name: "üì¶ Install support packages - Generic Build"
      working-directory: ./config
      run: |
        echo "Install support packages - Generic Build"
        packages=$(jq -r --arg prefix "$package_prefix" '.options.base.extras | map(.package) | map($prefix + "-" + .) | join(" ")' options.json)
        echo $packages
        pacman -S --noconfirm --overwrite '*' $packages
    - name: "üì¶ Install base level packages - Essentials Build"
      working-directory: ./config
      run: |
        echo "Install base packages - Essentials Build"
        packages=$(jq -r --arg prefix "$package_prefix" '.options.essentials.base | map(.package) | map($prefix + "-" + .) | join(" ")' options.json)
        echo $packages
        pacman -S --noconfirm --overwrite '*' $packages
    - name: "üì¶ Install base level packages - Full Build"
      working-directory: ./config
      run: |
        echo "Install base packages - Full Release build"
        packages=$(jq -r --arg prefix "$package_prefix" '.options.full.base | map(.package) | map($prefix + "-" + .) | join(" ")' options.json)
        echo $packages
        pacman -S --noconfirm --overwrite '*' $packages
    - name: "üì¶ Install external dependent packages - Essentials Build"
      working-directory: ./config
      run: |
        echo "Install external dependent packages - Essentials Release build"
        packages=$(jq -r --arg prefix "$package_prefix" '.options.essentials.dependent | map(.package) | map($prefix + "-" + .) | join(" ")' options.json)
        echo $packages
        pacman -S --noconfirm --overwrite '*' $packages
    - name: "üì¶ Install external dependent packages - Full Build"
      working-directory: ./config
      run: |
        echo "Install external dependent packages - Full Release build"
        packages=$(jq -r --arg prefix "$package_prefix" '.options.full.dependent | map(.package) | map($prefix + "-" + .) | join(" ")' options.json)
        echo $packages
        pacman -S --noconfirm --overwrite '*' $packages
    - name: "‚¨áÔ∏è Download External Packages"
      run: |
       mkdir packages
       gh release download "${toolchain_arch}" --pattern "*.zst" -D "./packages" -R tordona/mingw-packages
    - name: "‚û°Ô∏è Install External Packages"
      run: |
        echo "Install Custom Packages from External Repo"
        cd packages
        pacman -U --overwrite '*' --noconfirm *.pkg.tar.zst
    # - name: "‚¨áÔ∏è Download External Utlities"
    #   run: |
    #     mkdir utilities
    #     gh release download "rcedit" -D "./utilities" -R tordona/win-arm64-binaries
    #     cd utilities
    #     ls -la
    - uses: hmarr/debug-action@v3
    - name: "üå™Ô∏è Clone FFmpeg source repository"
      run: |
        mkdir source
        git clone --branch $inputs_github_tag $source_repo ./source
        cd source
        if test -f "RELEASE"; then
          version=$(<RELEASE)
          echo "source_version=$version" >> $GITHUB_ENV
        else
          echo "release version not found"
          exit 1
        fi
    - name: "üî® Test: Configure FFmpeg"
      run: |
        echo "Test tooling and library availability"
        cd source
        echo "$env:MSYS2_LOCATION"
        full_command="./configure --extra-libs='-static -lpthread -lm -liconv' --arch=aarch64 --enable-gpl --enable-version3 --enable-pic --enable-static --disable-shared --disable-debug --disable-w32threads --enable-pthreads --disable-autodetect --enable-iconv --enable-libxml2 --enable-bzlib --enable-lzma --enable-zlib --enable-dxva2 --enable-d3d11va --enable-d3d12va --enable-avisynth --enable-libaom  --enable-libfribidi --enable-libgme --enable-libgsm --enable-libmp3lame --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libopenjpeg --enable-libopenmpt --enable-libopus --enable-libspeex --enable-libsrt --enable-libtheora --enable-libvo-amrwbenc --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxvid --enable-mediafoundation --enable-sdl2 --enable-frei0r --enable-ladspa --enable-lcms2 --enable-libbs2b --enable-libcdio --enable-libdav1d --enable-libdvdnav --enable-libdvdread --enable-liblc3 --enable-libmysofa --enable-librav1e --enable-librist --enable-libshine --enable-libsnappy --enable-libsvtav1 --enable-libtwolame --enable-libxevd --enable-libxeve --enable-libzvbi --enable-liboapv --enable-libvvenc --enable-pic --disable-manpages --disable-podpages --disable-txtpages --extra-cflags=-I/d/msys64-dev/clangarm64/include --extra-ldflags='-Wl,--allow-multiple-definition'"
        extra="--extra-libs='-static -lpthread -lm -liconv'"
        arch="--arch=${toolchain_arch##clang\-}"
        generic_options=$(jq -r '.options.generic | map("--\(.status)-\(.option)") | join(" ")' ../config/options.json)
        command="./configure $extra $arch $generic_options"
        echo $command
        eval $command
    - name: "üî® Test: Configure FFmpeg"
      run: |
        echo "Test tooling and library availability"
        cd source
        make -j2
    - name: "üî® Test: Configure FFmpeg"
      run: |
        echo "Test tooling and library availability"
        cd source/ffbuild
        cat config.log